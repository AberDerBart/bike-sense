#include <avr/interrupt.h>
#include <avr/io.h>
#include <util/twi.h>
#include <stdio.h>
#include <stdlib.h>

#define GYRO_INT		(1 << PA0)
#define ACCEL_MAG_INT1		(1 << PA1)
#define ACCEL_MAG_INT2		(1 << PA2)

#define ROE_N			(1 << PB0)
#define GOE_N			(1 << PB1)
#define BOE_N			(1 << PB2)
#define OE_N			(ROE_N | GOE_N | BOE_N)
#define LED_SDI			(1 << PB3)
#define LED_SDO			(1 << PB4)
#define LED_CLK			(1 << PB5)
#define LED_LE			(1 << PB6)

#define COLUMN_INT		(1 << PC0)
#define FRAME_INT		(1 << PC1)
#define GPIO2_SDA1		(1 << PC4)
#define GPIO3_SCL1		(1 << PC5)

#define ACK_WRITE		0x60
#define ACK_READ		0xA8
#define DATA_RX			0x80
#define DATA_TX_ACK		0xb8
#define DATA_TX_NAK		0xc0

#define set(port,x) port |= (x)
#define clr(port,x) port &= ~(x)

extern void draw_loop(uint8_t *data);
extern void clear_gain(void);
extern void delay(uint8_t ticks);

enum REG_ADDR {
	REG_ID = 192,
	REG_CFG_LOW,
	REG_CFG_HIGH,
};

typedef enum {
	DAT_LATCH = 22,
	CONF_WRITE = 20,
	CONF_READ  = 18,
	GAIN_WRITE = 16,
	GAIN_READ = 14,
	DET_OPEN = 13,
	DET_SHORT = 12,
	DET_OPEN_SHORT = 11,
	THERM_READ = 10,
} le_key;

uint8_t intensity[192] = {
	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,
	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,
	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,

	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,
	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,
	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,

	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,
	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,
	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,

	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,
	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,
	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,

	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,
	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,
	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,

	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,
	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,
	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,

	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,
	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,
	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,

	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,
	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,
	0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,
};

int main(void)
{
	PORTA = 0;
	PORTB = 0;
	PORTC = 0;
	PORTD = 0;
	DDRA = GYRO_INT | ACCEL_MAG_INT1 | ACCEL_MAG_INT2;
	DDRB = ROE_N | GOE_N | BOE_N | LED_SDI | LED_CLK | LED_LE;
	DDRC = COLUMN_INT | FRAME_INT | GPIO2_SDA1;
	DDRD = 0xFF;

	TCCR0A = (1<<CS12);

	TWBR = 0xff;
	TWAR = 0x46 << 1;
	TWCR = (1 << TWEA) | (1 << TWEN) | (1 << TWINT) | (1 << TWIE);
	delay(255);
	clear_gain();
	sei();
	draw_loop(intensity);
	for(;;);
}
